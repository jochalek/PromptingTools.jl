import { _ as _export_sfc, c as createElementBlock, o as openBlock, a7 as createStaticVNode } from "./chunks/framework.C1vzEJDW.js";
const __pageData = JSON.parse('{"title":"RAG Tools Introduction","description":"","frontmatter":{},"headers":[],"relativePath":"extra_tools/rag_tools_intro.md","filePath":"extra_tools/rag_tools_intro.md","lastUpdated":null}');
const _sfc_main = { name: "extra_tools/rag_tools_intro.md" };
const _hoisted_1 = /* @__PURE__ */ createStaticVNode('<h1 id="RAG-Tools-Introduction" tabindex="-1">RAG Tools Introduction <a class="header-anchor" href="#RAG-Tools-Introduction" aria-label="Permalink to &quot;RAG Tools Introduction {#RAG-Tools-Introduction}&quot;">​</a></h1><p><code>RAGTools</code> is an experimental module that provides a set of utilities for building Retrieval-Augmented Generation (RAG) applications, ie, applications that generate answers by combining knowledge of the underlying AI model with the information from the user&#39;s knowledge base.</p><p>It is designed to be powerful and flexible, allowing you to build RAG applications with minimal effort. Extend any step of the pipeline with your own custom code (see the <a href="/PromptingTools.jl/previews/PR103/extra_tools/rag_tools_intro#RAG-Interface">RAG Interface</a> section), or use the provided defaults to get started quickly.</p><p>Once the API stabilizes (near term), we hope to carve it out into a separate package.</p><p>Import the module as follows:</p><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># required dependencies to load the necessary extensions!!!</span></span>\n<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">using</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> LinearAlgebra, SparseArrays </span></span>\n<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">using</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> PromptingTools</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Experimental</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">RAGTools</span></span>\n<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># to access unexported functionality</span></span>\n<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> RT </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> PromptingTools</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Experimental</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">RAGTools</span></span></code></pre></div><h2 id="Highlights" tabindex="-1">Highlights <a class="header-anchor" href="#Highlights" aria-label="Permalink to &quot;Highlights {#Highlights}&quot;">​</a></h2><p>The main functions to be aware of are:</p><ul><li><p><code>build_index</code> to build a RAG index from a list of documents (type <code>ChunkIndex</code>)</p></li><li><p><code>airag</code> to generate answers using the RAG model on top of the <code>index</code> built above</p><ul><li><p><code>retrieve</code> to retrieve relevant chunks from the index for a given question</p></li><li><p><code>generate!</code> to generate an answer from the retrieved chunks</p></li></ul></li><li><p><code>annotate_support</code> to highlight which parts of the RAG answer are supported by the documents in the index vs which are generated by the model, it is applied automatically if you use pretty printing with <code>pprint</code> (eg, <code>pprint(result)</code>)</p></li><li><p><code>build_qa_evals</code> to build a set of question-answer pairs for evaluation of the RAG model from your corpus</p></li></ul><p>The hope is to provide a modular and easily extensible set of tools for building RAG applications in Julia. Feel free to open an issue or ask in the <code>#generative-ai</code> channel in the JuliaLang Slack if you have a specific need.</p><h2 id="Examples" tabindex="-1">Examples <a class="header-anchor" href="#Examples" aria-label="Permalink to &quot;Examples {#Examples}&quot;">​</a></h2><p>Let&#39;s build an index, we need to provide a starter list of documents:</p><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">sentences </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span></span>\n<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;Find the most comprehensive guide on Julia programming language for beginners published in 2023.&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>\n<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;Search for the latest advancements in quantum computing using Julia language.&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>\n<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;How to implement machine learning algorithms in Julia with examples.&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>\n<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;Looking for performance comparison between Julia, Python, and R for data analysis.&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>\n<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;Find Julia language tutorials focusing on high-performance scientific computing.&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>\n<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;Search for the top Julia language packages for data visualization and their documentation.&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>\n<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;How to set up a Julia development environment on Windows 10.&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>\n<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;Discover the best practices for parallel computing in Julia.&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>\n<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;Search for case studies of large-scale data processing using Julia.&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>\n<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;Find comprehensive resources for mastering metaprogramming in Julia.&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>\n<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;Looking for articles on the advantages of using Julia for statistical modeling.&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>\n<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;How to contribute to the Julia open-source community: A step-by-step guide.&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>\n<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;Find the comparison of numerical accuracy between Julia and MATLAB.&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>\n<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;Looking for the latest Julia language updates and their impact on AI research.&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>\n<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;How to efficiently handle big data with Julia: Techniques and libraries.&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>\n<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;Discover how Julia integrates with other programming languages and tools.&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>\n<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;Search for Julia-based frameworks for developing web applications.&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>\n<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;Find tutorials on creating interactive dashboards with Julia.&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>\n<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;How to use Julia for natural language processing and text analysis.&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>\n<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;Discover the role of Julia in the future of computational finance and econometrics.&quot;</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span></code></pre></div><p>Let&#39;s index these &quot;documents&quot;:</p><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">index </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> build_index</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(sentences; chunker_kwargs</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(; sources</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">map</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;Doc</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">$i</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">length</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(sentences))))</span></span></code></pre></div><p>This would be equivalent to the following <code>index = build_index(SimpleIndexer(), sentences)</code> which dispatches to the default implementation of each step via the <code>SimpleIndexer</code> struct. We provide these default implementations for the main functions as an optional argument - no need to provide them if you&#39;re running the default pipeline.</p><p>Notice that we have provided a <code>chunker_kwargs</code> argument to the <code>build_index</code> function. These will be kwargs passed to <code>chunker</code> step.</p><p>Now let&#39;s generate an answer to a question.</p><ol><li>Run end-to-end RAG (retrieve + generate!), return <code>AIMessage</code></li></ol><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">question </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;What are the best practices for parallel computing in Julia?&quot;</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">msg </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> airag</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(index; question) </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># short for airag(RAGConfig(), index; question)</span></span>\n<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">## Output:</span></span>\n<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">## [ Info: Done with RAG. Total cost: \\$0.0</span></span>\n<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">## AIMessage(&quot;Some best practices for parallel computing in Julia include us...</span></span></code></pre></div><ol><li>Explore what&#39;s happening under the hood by changing the return type - <code>RAGResult</code> contains all intermediate steps.</li></ol><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">result </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> airag</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(index; question, return_all</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>\n<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">## RAGResult</span></span>\n<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">##   question: String &quot;What are the best practices for parallel computing in Julia?&quot;</span></span>\n<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">##   rephrased_questions: Array{String}((1,))</span></span>\n<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">##   answer: SubString{String}</span></span>\n<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">##   final_answer: SubString{String}</span></span>\n<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">##   context: Array{String}((5,))</span></span>\n<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">##   sources: Array{String}((5,))</span></span>\n<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">##   emb_candidates: CandidateChunks{Int64, Float32}</span></span>\n<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">##   tag_candidates: CandidateChunks{Int64, Float32}</span></span>\n<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">##   filtered_candidates: CandidateChunks{Int64, Float32}</span></span>\n<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">##   reranked_candidates: CandidateChunks{Int64, Float32}</span></span>\n<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">##   conversations: Dict{Symbol, Vector{&lt;:PromptingTools.AbstractMessage}}</span></span></code></pre></div><p>You can still get the message from the result, see <code>result.conversations[:final_answer]</code> (the dictionary keys correspond to the function names of those steps).</p><ol><li>If you need to customize it, break the pipeline into its sub-steps: retrieve and generate - RAGResult serves as the intermediate result.</li></ol><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Retrieve which chunks are relevant to the question</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">result </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> retrieve</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(index, question)</span></span>\n<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Generate an answer</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">result </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> generate!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(index, result)</span></span></code></pre></div><p>You can leverage a pretty-printing system with <code>pprint</code> where we automatically annotate the support of the answer by the chunks we provided to the model. It is configurable and you can select only some of its functions (eg, scores, sources).</p><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">pprint</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(result)</span></span></code></pre></div><p>You&#39;ll see the following in REPL but with COLOR highlighting in the terminal.</p><div class="language-plaintext vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">plaintext</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>--------------------</span></span>\n<span class="line"><span>QUESTION(s)</span></span>\n<span class="line"><span>--------------------</span></span>\n<span class="line"><span>- What are the best practices for parallel computing in Julia?</span></span>\n<span class="line"><span></span></span>\n<span class="line"><span>--------------------</span></span>\n<span class="line"><span>ANSWER</span></span>\n<span class="line"><span>--------------------</span></span>\n<span class="line"><span>Some of the best practices for parallel computing in Julia include:[1,0.7]</span></span>\n<span class="line"><span>- Using [3,0.4]`@threads` for simple parallelism[1,0.34]</span></span>\n<span class="line"><span>- Utilizing `Distributed` module for more complex parallel tasks[1,0.19]</span></span>\n<span class="line"><span>- Avoiding excessive memory allocation</span></span>\n<span class="line"><span>- Considering task granularity for efficient workload distribution</span></span>\n<span class="line"><span></span></span>\n<span class="line"><span>--------------------</span></span>\n<span class="line"><span>SOURCES</span></span>\n<span class="line"><span>--------------------</span></span>\n<span class="line"><span>1. Doc8</span></span>\n<span class="line"><span>2. Doc15</span></span>\n<span class="line"><span>3. Doc5</span></span>\n<span class="line"><span>4. Doc2</span></span>\n<span class="line"><span>5. Doc9</span></span></code></pre></div><p><strong>How to read the output</strong></p><ul><li><p>Color legend:</p><ul><li><p>No color: High match with the context, can be trusted more</p></li><li><p>Blue: Partial match against some words in the context, investigate</p></li><li><p>Magenta (Red): No match with the context, fully generated by the model</p></li></ul></li><li><p>Square brackets: The best matching context ID + Match score of the chunk (eg, <code>[3,0.4]</code> means the highest support for the sentence is from the context chunk number 3 with a 40% match).</p></li></ul><p>Want more?</p><p>See <code>examples/building_RAG.jl</code> for one more example.</p><h2 id="RAG-Interface" tabindex="-1">RAG Interface <a class="header-anchor" href="#RAG-Interface" aria-label="Permalink to &quot;RAG Interface {#RAG-Interface}&quot;">​</a></h2><h3 id="System-Overview" tabindex="-1">System Overview <a class="header-anchor" href="#System-Overview" aria-label="Permalink to &quot;System Overview {#System-Overview}&quot;">​</a></h3><p>This system is designed for information retrieval and response generation, structured in three main phases:</p><ul><li><p>Preparation, when you create an instance of <code>AbstractIndex</code></p></li><li><p>Retrieval, when you surface the top most relevant chunks/items in the <code>index</code> and return <code>AbstractRAGResult</code>, which contains the references to the chunks (<code>AbstractCandidateChunks</code>)</p></li><li><p>Generation, when you generate an answer based on the context built from the retrieved chunks, return either <code>AIMessage</code> or <code>AbstractRAGResult</code></p></li></ul><p>The system is designed to be hackable and extensible at almost every entry point. If you want to customize the behavior of any step, you can do so by defining a new type and defining a new method for the step you&#39;re changing, eg,</p><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> MyReranker </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> AbstractReranker</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> end</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">RT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">rerank</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">MyReranker</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, index, candidates) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ...</span></span></code></pre></div><p>And then you&#39;d ask for the <code>retrive</code> step to use your custom <code>MyReranker</code>, eg, <code>retrieve(....; reranker = MyReranker())</code> (or customize the main dispatching <code>AbstractRetriever</code> struct).</p><p>The overarching principles are:</p><ul><li><p>Always dispatch / customize the behavior by defining a new <code>Struct</code> and the corresponding method for the existing functions (eg, <code>rerank</code> function for the re-ranking step).</p></li><li><p>Custom types are provided as the first argument (the high-level functions will work without them as we provide some defaults).</p></li><li><p>Custom types do NOT have any internal fields or DATA (with the exception of managing sub-steps of the pipeline like <code>AbstractRetriever</code> or <code>RAGConfig</code>).</p></li><li><p>Additional data should be passed around as keyword arguments (eg, <code>chunker_kwargs</code> in <code>build_index</code> to pass data to the chunking step). The intention was to have some clearly documented default values in the docstrings of each step + to have the various options all in one place.</p></li></ul><h3 id="RAG-Diagram" tabindex="-1">RAG Diagram <a class="header-anchor" href="#RAG-Diagram" aria-label="Permalink to &quot;RAG Diagram {#RAG-Diagram}&quot;">​</a></h3><p>The main functions are:</p><p><code>build_index</code>:</p><ul><li><p>signature: <code>(indexer::AbstractIndexBuilder, files_or_docs::Vector{&lt;:AbstractString}) -&gt; AbstractChunkIndex</code></p></li><li><p>flow: <code>get_chunks</code> -&gt; <code>get_embeddings</code> -&gt; <code>get_tags</code> -&gt; <code>build_tags</code></p></li><li><p>dispatch types: <code>AbstractIndexBuilder</code>, <code>AbstractChunker</code>, <code>AbstractEmbedder</code>, <code>AbstractTagger</code></p></li></ul><p><code>airag</code>:</p><ul><li><p>signature: <code>(cfg::AbstractRAGConfig, index::AbstractChunkIndex; question::AbstractString)</code> -&gt; <code>AIMessage</code> or <code>AbstractRAGResult</code></p></li><li><p>flow: <code>retrieve</code> -&gt; <code>generate!</code></p></li><li><p>dispatch types: <code>AbstractRAGConfig</code>, <code>AbstractRetriever</code>, <code>AbstractGenerator</code></p></li></ul><p><code>retrieve</code>:</p><ul><li><p>signature: <code>(retriever::AbstractRetriever, index::AbstractChunkIndex, question::AbstractString) -&gt; AbstractRAGResult</code></p></li><li><p>flow: <code>rephrase</code> -&gt; <code>get_embeddings</code> -&gt; <code>find_closest</code> -&gt; <code>get_tags</code> -&gt; <code>find_tags</code> -&gt; <code>rerank</code></p></li><li><p>dispatch types: <code>AbstractRAGConfig</code>, <code>AbstractRephraser</code>, <code>AbstractEmbedder</code>, <code>AbstractSimilarityFinder</code>, <code>AbstractTagger</code>, <code>AbstractTagFilter</code>, <code>AbstractReranker</code></p></li></ul><p><code>generate!</code>:</p><ul><li><p>signature: <code>(generator::AbstractGenerator, index::AbstractChunkIndex, result::AbstractRAGResult)</code> -&gt; <code>AIMessage</code> or <code>AbstractRAGResult</code></p></li><li><p>flow: <code>build_context!</code> -&gt; <code>answer!</code> -&gt; <code>refine!</code> -&gt; <code>postprocess!</code></p></li><li><p>dispatch types: <code>AbstractGenerator</code>, <code>AbstractContextBuilder</code>, <code>AbstractAnswerer</code>, <code>AbstractRefiner</code>, <code>AbstractPostprocessor</code></p></li></ul><p>To discover the currently available implementations, use <code>subtypes</code> function, eg, <code>subtypes(AbstractReranker)</code>.</p><h3 id="Deepdive" tabindex="-1">Deepdive <a class="header-anchor" href="#Deepdive" aria-label="Permalink to &quot;Deepdive {#Deepdive}&quot;">​</a></h3><p><strong>Preparation Phase:</strong></p><ul><li><p>Begins with <code>build_index</code>, which creates a user-defined index type from an abstract chunk index using specified dels and function strategies.</p></li><li><p><code>get_chunks</code> then divides the indexed data into manageable pieces based on a chunking strategy.</p></li><li><p><code>get_embeddings</code> generates embeddings for each chunk using an embedding strategy to facilitate similarity arches.</p></li><li><p>Finally, <code>get_tags</code> extracts relevant metadata from each chunk, enabling tag-based filtering (hybrid search index). If there are <code>tags</code> available, <code>build_tags</code> is called to build the corresponding sparse matrix for filtering with tags.</p></li></ul><p><strong>Retrieval Phase:</strong></p><ul><li><p>The <code>retrieve</code> step is intended to find the most relevant chunks in the <code>index</code>.</p></li><li><p><code>rephrase</code> is called first, if we want to rephrase the query (methods like <code>HyDE</code> can improve retrieval quite a bit)!</p></li><li><p><code>get_embeddings</code> generates embeddings for the original + rephrased query</p></li><li><p><code>find_closest</code> looks up the most relevant candidates (<code>CandidateChunks</code>) using a similarity search strategy.</p></li><li><p><code>get_tags</code> extracts the potential tags (can be provided as part of the <code>airag</code> call, eg, when we want to use only some small part of the indexed chunks)</p></li><li><p><code>find_tags</code> filters the candidates to strictly match <em>at least one</em> of the tags (if provided)</p></li><li><p><code>rerank</code> is called to rerank the candidates based on the reranking strategy (ie, to improve the ordering of the chunks in context).</p></li></ul><p><strong>Generation Phase:</strong></p><ul><li><p>The <code>generate</code> step is intended to generate a response based on the retrieved chunks, provided via <code>AbstractRAGResult</code> (eg, <code>RAGResult</code>).</p></li><li><p><code>build_context!</code> constructs the context for response generation based on a context strategy and applies the necessary formatting</p></li><li><p><code>answer!</code> generates the response based on the context and the query</p></li><li><p><code>refine!</code> is called to refine the response (optional, defaults to passthrough)</p></li><li><p><code>postprocessing!</code> is available for any final touches to the response or to potentially save or format the results (eg, automatically save to the disk)</p></li></ul><p>Note that all generation steps are mutating the <code>RAGResult</code> object.</p><p>See more details and corresponding functions and types in <code>src/Experimental/RAGTools/rag_interface.jl</code>.</p><h2 id="References" tabindex="-1">References <a class="header-anchor" href="#References" aria-label="Permalink to &quot;References {#References}&quot;">​</a></h2><div style="border-width:1px;border-style:solid;border-color:black;padding:1em;border-radius:25px;"><a id="PromptingTools.Experimental.RAGTools.build_index-extra_tools-rag_tools_intro" href="#PromptingTools.Experimental.RAGTools.build_index-extra_tools-rag_tools_intro">#</a> <b><u>PromptingTools.Experimental.RAGTools.build_index</u></b> — <i>Function</i>. <div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">build_index</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    indexer</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">AbstractIndexBuilder</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, files_or_docs</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Vector{&lt;:AbstractString}</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    verbose</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Integer</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    extras</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Union{Nothing, AbstractVector}</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> nothing</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    index_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> gensym</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;ChunkIndex&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">),</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    chunker</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">AbstractChunker</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> indexer</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">chunker,</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    chunker_kwargs</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">NamedTuple</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> NamedTuple</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(),</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    embedder</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">AbstractEmbedder</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> indexer</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">embedder,</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    embedder_kwargs</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">NamedTuple</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> NamedTuple</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(),</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    tagger</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">AbstractTagger</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> indexer</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">tagger,</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    tagger_kwargs</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">NamedTuple</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> NamedTuple</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(),</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    api_kwargs</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">NamedTuple</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> NamedTuple</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(),</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    cost_tracker </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Threads</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Atomic{Float64}</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0.0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">))</span></span></code></pre></div><p>Build an INDEX for RAG (Retriever-Augmented Generation) applications from the provided file paths. INDEX is a object storing the document chunks and their embeddings (and potentially other information).</p><p>The function processes each file or document (depending on <code>chunker</code>), splits its content into chunks, embeds these chunks, optionally extracts metadata, and then combines this information into a retrievable index.</p><p>Define your own methods via <code>indexer</code> and its subcomponents (<code>chunker</code>, <code>embedder</code>, <code>tagger</code>).</p><p><strong>Arguments</strong></p><ul><li><p><code>indexer::AbstractIndexBuilder</code>: The indexing logic to use. Default is <code>SimpleIndexer()</code>.</p></li><li><p><code>files_or_docs</code>: A vector of valid file paths OR string documents to be indexed (chunked and embedded). Specify which mode to use via <code>chunker</code>.</p></li><li><p><code>verbose</code>: An Integer specifying the verbosity of the logs. Default is <code>1</code> (high-level logging). <code>0</code> is disabled.</p></li><li><p><code>extras</code>: An optional vector of extra information to be stored with each chunk. Default is <code>nothing</code>.</p></li><li><p><code>index_id</code>: A unique identifier for the index. Default is a generated symbol.</p></li><li><p><code>chunker</code>: The chunker logic to use for splitting the documents. Default is <code>TextChunker()</code>.</p></li><li><p><code>chunker_kwargs</code>: Parameters to be provided to the <code>get_chunks</code> function. Useful to change the <code>separators</code> or <code>max_length</code>.</p><ul><li><code>sources</code>: A vector of strings indicating the source of each chunk. Default is equal to <code>files_or_docs</code>.</li></ul></li><li><p><code>embedder</code>: The embedder logic to use for embedding the chunks. Default is <code>BatchEmbedder()</code>.</p></li><li><p><code>embedder_kwargs</code>: Parameters to be provided to the <code>get_embeddings</code> function. Useful to change the <code>target_batch_size_length</code> or reduce asyncmap tasks <code>ntasks</code>.</p><ul><li><code>model</code>: The model to use for embedding. Default is <code>PT.MODEL_EMBEDDING</code>.</li></ul></li><li><p><code>tagger</code>: The tagger logic to use for extracting tags from the chunks. Default is <code>NoTagger()</code>, ie, skip tag extraction. There are also <code>PassthroughTagger</code> and <code>OpenTagger</code>.</p></li><li><p><code>tagger_kwargs</code>: Parameters to be provided to the <code>get_tags</code> function.</p><ul><li><p><code>model</code>: The model to use for tags extraction. Default is <code>PT.MODEL_CHAT</code>.</p></li><li><p><code>template</code>: A template to be used for tags extraction. Default is <code>:RAGExtractMetadataShort</code>.</p></li><li><p><code>tags</code>: A vector of vectors of strings directly providing the tags for each chunk. Applicable for <code>tagger::PasstroughTagger</code>.</p></li></ul></li><li><p><code>api_kwargs</code>: Parameters to be provided to the API endpoint. Shared across all API calls if provided.</p></li><li><p><code>cost_tracker</code>: A <code>Threads.Atomic{Float64}</code> object to track the total cost of the API calls. Useful to pass the total cost to the parent call.</p></li></ul><p><strong>Returns</strong></p><ul><li><code>ChunkIndex</code>: An object containing the compiled index of chunks, embeddings, tags, vocabulary, and sources.</li></ul><p>See also: <code>ChunkIndex</code>, <code>get_chunks</code>, <code>get_embeddings</code>, <code>get_tags</code>, <code>CandidateChunks</code>, <code>find_closest</code>, <code>find_tags</code>, <code>rerank</code>, <code>retrieve</code>, <code>generate!</code>, <code>airag</code></p><p><strong>Examples</strong></p><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Default is loading a vector of strings and chunking them (`TextChunker()`)</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">index </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> build_index</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">SimpleIndexer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(), texts; chunker_kwargs </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (; max_length</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">))</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Another example with tags extraction, splitting only sentences and verbose output</span></span>\n<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Assuming `test_files` is a vector of file paths</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">indexer </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> SimpleIndexer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(chunker</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">FileChunker</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(), tagger</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">OpenTagger</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">())</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">index </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> build_index</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(indexer, test_files; </span></span>\n<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        chunker_kwargs</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(; separators</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;. &quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]), verbose</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><p><strong>Notes</strong></p><ul><li>If you get errors about exceeding embedding input sizes, first check the <code>max_length</code> in your chunks. If that does NOT resolve the issue, try changing the <code>embedding_kwargs</code>. In particular, reducing the <code>target_batch_size_length</code> parameter (eg, 10_000) and number of tasks <code>ntasks=1</code>. Some providers cannot handle large batch sizes (eg, Databricks).</li></ul><p><a href="https://github.com/svilupp/PromptingTools.jl/blob/1671239c38c0b309f52f81d9522c51f593517a4f/src/Experimental/RAGTools/preparation.jl#L339-L405" target="_blank" rel="noreferrer">source</a></p></div><br><div style="border-width:1px;border-style:solid;border-color:black;padding:1em;border-radius:25px;"><a id="PromptingTools.Experimental.RAGTools.airag-extra_tools-rag_tools_intro" href="#PromptingTools.Experimental.RAGTools.airag-extra_tools-rag_tools_intro">#</a> <b><u>PromptingTools.Experimental.RAGTools.airag</u></b> — <i>Function</i>. <div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">airag</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(cfg</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">AbstractRAGConfig</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, index</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">AbstractChunkIndex</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    question</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">AbstractString</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    verbose</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Integer</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, return_all</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Bool</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    api_kwargs</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">NamedTuple</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> NamedTuple</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(),</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    retriever</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">AbstractRetriever</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> cfg</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">retriever,</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    retriever_kwargs</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">NamedTuple</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> NamedTuple</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(),</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    generator</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">AbstractGenerator</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> cfg</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">generator,</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    generator_kwargs</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">NamedTuple</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> NamedTuple</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(),</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    cost_tracker </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Threads</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Atomic{Float64}</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0.0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">))</span></span></code></pre></div><p>High-level wrapper for Retrieval-Augmented Generation (RAG), it combines together the <code>retrieve</code> and <code>generate!</code> steps which you can customize if needed.</p><p>The simplest version first finds the relevant chunks in <code>index</code> for the <code>question</code> and then sends these chunks to the AI model to help with generating a response to the <code>question</code>.</p><p>To customize the components, replace the types (<code>retriever</code>, <code>generator</code>) of the corresponding step of the RAG pipeline - or go into sub-routines within the steps. Eg, use <code>subtypes(AbstractRetriever)</code> to find the available options.</p><p><strong>Arguments</strong></p><ul><li><p><code>cfg::AbstractRAGConfig</code>: The configuration for the RAG pipeline. Defaults to <code>RAGConfig()</code>, where you can swap sub-types to customize the pipeline.</p></li><li><p><code>index::AbstractChunkIndex</code>: The chunk index to search for relevant text.</p></li><li><p><code>question::AbstractString</code>: The question to be answered.</p></li><li><p><code>return_all::Bool</code>: If <code>true</code>, returns the details used for RAG along with the response.</p></li><li><p><code>verbose::Integer</code>: If <code>&gt;0</code>, enables verbose logging. The higher the number, the more nested functions will log.</p></li><li><p><code>api_kwargs</code>: API parameters that will be forwarded to ALL of the API calls (<code>aiembed</code>, <code>aigenerate</code>, and <code>aiextract</code>).</p></li><li><p><code>retriever::AbstractRetriever</code>: The retriever to use for finding relevant chunks. Defaults to <code>cfg.retriever</code>, eg, <code>SimpleRetriever</code> (with no question rephrasing).</p></li><li><p><code>retriever_kwargs::NamedTuple</code>: API parameters that will be forwarded to the <code>retriever</code> call. Examples of important ones:</p><ul><li><p><code>top_k::Int</code>: Number of top candidates to retrieve based on embedding similarity.</p></li><li><p><code>top_n::Int</code>: Number of candidates to return after reranking.</p></li><li><p><code>tagger::AbstractTagger</code>: Tagger to use for tagging the chunks. Defaults to <code>NoTagger()</code>.</p></li><li><p><code>tagger_kwargs::NamedTuple</code>: API parameters that will be forwarded to the <code>tagger</code> call. You could provide the explicit tags directly with <code>PassthroughTagger</code> and <code>tagger_kwargs = (; tags = [&quot;tag1&quot;, &quot;tag2&quot;])</code>.</p></li></ul></li><li><p><code>generator::AbstractGenerator</code>: The generator to use for generating the answer. Defaults to <code>cfg.generator</code>, eg, <code>SimpleGenerator</code>.</p></li><li><p><code>generator_kwargs::NamedTuple</code>: API parameters that will be forwarded to the <code>generator</code> call. Examples of important ones:</p><ul><li><p><code>answerer_kwargs::NamedTuple</code>: API parameters that will be forwarded to the <code>answerer</code> call. Examples:</p><ul><li><p><code>model</code>: The model to use for generating the answer. Defaults to <code>PT.MODEL_CHAT</code>.</p></li><li><p><code>template</code>: The template to use for the <code>aigenerate</code> function. Defaults to <code>:RAGAnswerFromContext</code>.</p></li></ul></li><li><p><code>refiner::AbstractRefiner</code>: The method to use for refining the answer. Defaults to <code>generator.refiner</code>, eg, <code>NoRefiner</code>.</p></li><li><p><code>refiner_kwargs::NamedTuple</code>: API parameters that will be forwarded to the <code>refiner</code> call.</p><ul><li><p><code>model</code>: The model to use for generating the answer. Defaults to <code>PT.MODEL_CHAT</code>.</p></li><li><p><code>template</code>: The template to use for the <code>aigenerate</code> function. Defaults to <code>:RAGAnswerRefiner</code>.</p></li></ul></li></ul></li><li><p><code>cost_tracker</code>: An atomic counter to track the total cost of the operations (if you want to track the cost of multiple pipeline runs - it passed around in the pipeline).</p></li></ul><p><strong>Returns</strong></p><ul><li><p>If <code>return_all</code> is <code>false</code>, returns the generated message (<code>msg</code>).</p></li><li><p>If <code>return_all</code> is <code>true</code>, returns the detail of the full pipeline in <code>RAGResult</code> (see the docs).</p></li></ul><p>See also <code>build_index</code>, <code>retrieve</code>, <code>generate!</code>, <code>RAGResult</code></p><p><strong>Examples</strong></p><p>Using <code>airag</code> to get a response for a question:</p><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">index </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> build_index</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># create an index</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">question </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;How to make a barplot in Makie.jl?&quot;</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">msg </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> airag</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(index; question)</span></span></code></pre></div><p>To understand the details of the RAG process, use <code>return_all=true</code></p><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">msg, details </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> airag</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(index; question, return_all </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>\n<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># details is a RAGDetails object with all the internal steps of the `airag` function</span></span></code></pre></div><p>You can also pretty-print <code>details</code> to highlight generated text vs text that is supported by context. It also includes annotations of which context was used for each part of the response (where available).</p><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">PT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">pprint</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(details)</span></span></code></pre></div><p>Example with advanced retrieval (with question rephrasing and reranking (requires <code>COHERE_API_KEY</code>). We will obtain top 100 chunks from embeddings (<code>top_k</code>) and top 5 chunks from reranking (<code>top_n</code>). In addition, it will be done with a &quot;custom&quot; locally-hosted model.</p><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">cfg </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> RAGConfig</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(; retriever </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> AdvancedRetriever</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">())</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># kwargs will be big and nested, let&#39;s prepare them upfront</span></span>\n<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># we specify &quot;custom&quot; model for each component that calls LLM</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">kwargs </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    retriever_kwargs </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (;</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        top_k </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 100</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        top_n </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 5</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        rephraser_kwargs </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (;</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            model </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;custom&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">),</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        embedder_kwargs </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (;</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            model </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;custom&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">),</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        tagger_kwargs </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (;</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            model </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;custom&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)),</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    generator_kwargs </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (;</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        answerer_kwargs </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (;</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            model </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;custom&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">),</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        refiner_kwargs </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (;</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            model </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;custom&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)),</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    api_kwargs </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (;</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        url </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;http://localhost:8080&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">))</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">result </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> airag</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(cfg, index, question; kwargs</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><p><a href="https://github.com/svilupp/PromptingTools.jl/blob/1671239c38c0b309f52f81d9522c51f593517a4f/src/Experimental/RAGTools/generation.jl#L403-L501" target="_blank" rel="noreferrer">source</a></p></div><br><div style="border-width:1px;border-style:solid;border-color:black;padding:1em;border-radius:25px;"><a id="PromptingTools.Experimental.RAGTools.annotate_support-extra_tools-rag_tools_intro" href="#PromptingTools.Experimental.RAGTools.annotate_support-extra_tools-rag_tools_intro">#</a> <b><u>PromptingTools.Experimental.RAGTools.annotate_support</u></b> — <i>Function</i>. <div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">annotate_support</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(annotater</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">TrigramAnnotater</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, answer</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">AbstractString</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    context</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">AbstractVector</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; min_score</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Float64</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0.5</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    skip_trigrams</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Bool</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, hashed</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Bool</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    sources</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Union{Nothing, AbstractVector{&lt;:AbstractString}}</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> nothing</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    min_source_score</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Float64</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0.25</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    add_sources</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Bool</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    add_scores</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Bool</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, kwargs</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><p>Annotates the <code>answer</code> with the overlap/what&#39;s supported in <code>context</code> and returns the annotated tree of nodes representing the <code>answer</code></p><p>Returns a &quot;root&quot; node with children nodes representing the sentences/code blocks in the <code>answer</code>. Only the &quot;leaf&quot; nodes are to be printed (to avoid duplication), &quot;leaf&quot; nodes are those with NO children.</p><p>Default logic:</p><ul><li><p>Split into sentences/code blocks, then into tokens (~words).</p></li><li><p>Then match each token (~word) exactly.</p></li><li><p>If no exact match found, count trigram-based match (include the surrounding tokens for better contextual awareness).</p></li><li><p>If the match is higher than <code>min_score</code>, it&#39;s recorded in the <code>score</code> of the node.</p></li></ul><p><strong>Arguments</strong></p><ul><li><p><code>annotater::TrigramAnnotater</code>: Annotater to use</p></li><li><p><code>answer::AbstractString</code>: Text to annotate</p></li><li><p><code>context::AbstractVector</code>: Context to annotate against, ie, look for &quot;support&quot; in the texts in <code>context</code></p></li><li><p><code>min_score::Float64</code>: Minimum score to consider a match. Default: 0.5, which means that half of the trigrams of each word should match</p></li><li><p><code>skip_trigrams::Bool</code>: Whether to potentially skip trigram matching if exact full match is found. Default: true</p></li><li><p><code>hashed::Bool</code>: Whether to use hashed trigrams. It&#39;s harder to debug, but it&#39;s much faster for larger texts (hashed text are held in a Set to deduplicate). Default: true</p></li><li><p><code>sources::Union{Nothing, AbstractVector{&lt;:AbstractString}}</code>: Sources to add at the end of the context. Default: nothing</p></li><li><p><code>min_source_score::Float64</code>: Minimum score to consider/to display a source. Default: 0.25, which means that at least a quarter of the trigrams of each word should match to some context. The threshold is lower than <code>min_score</code>, because it&#39;s average across ALL words in a block, so it&#39;s much harder to match fully with generated text.</p></li><li><p><code>add_sources::Bool</code>: Whether to add sources at the end of each code block/sentence. Sources are addded in the square brackets like &quot;[1]&quot;. Default: true</p></li><li><p><code>add_scores::Bool</code>: Whether to add source-matching scores at the end of each code block/sentence. Scores are added in the square brackets like &quot;[0.75]&quot;. Default: true</p></li><li><p>kwargs: Additional keyword arguments to pass to <code>trigram_support!</code> and <code>set_node_style!</code>. See their documentation for more details (eg, customize the colors of the nodes based on the score)</p></li></ul><p><strong>Example</strong></p><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">annotater </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> TrigramAnnotater</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">context </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span></span>\n<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;This is a test context.&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Another context sentence.&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Final piece of context.&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">answer </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;This is a test context. Another context sentence.&quot;</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">annotated_root </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> annotate_support</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(annotater, answer, context)</span></span>\n<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">pprint</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(annotated_root) </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># pretty print the annotated tree</span></span></code></pre></div><p><a href="https://github.com/svilupp/PromptingTools.jl/blob/1671239c38c0b309f52f81d9522c51f593517a4f/src/Experimental/RAGTools/annotation.jl#L401-L444" target="_blank" rel="noreferrer">source</a></p><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">annotate_support</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    annotater</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">TrigramAnnotater</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, result</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">AbstractRAGResult</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; min_score</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Float64</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0.5</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    skip_trigrams</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Bool</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, hashed</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Bool</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    min_source_score</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Float64</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0.25</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    add_sources</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Bool</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    add_scores</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Bool</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, kwargs</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><p>Dispatch for <code>annotate_support</code> for <code>AbstractRAGResult</code> type. It extracts the <code>final_answer</code> and <code>context</code> from the <code>result</code> and calls <code>annotate_support</code> with them.</p><p>See <code>annotate_support</code> for more details.</p><p><strong>Example</strong></p><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">res </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> RAGResult</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(; question </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, final_answer </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;This is a test.&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    context </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Test context.&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Completely different&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">])</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">annotated_root </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> annotate_support</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(annotater, res)</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">PT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">pprint</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(annotated_root)</span></span></code></pre></div><p><a href="https://github.com/svilupp/PromptingTools.jl/blob/1671239c38c0b309f52f81d9522c51f593517a4f/src/Experimental/RAGTools/annotation.jl#L494-L513" target="_blank" rel="noreferrer">source</a></p></div><br><div style="border-width:1px;border-style:solid;border-color:black;padding:1em;border-radius:25px;"><a id="PromptingTools.Experimental.RAGTools.build_qa_evals-extra_tools-rag_tools_intro" href="#PromptingTools.Experimental.RAGTools.build_qa_evals-extra_tools-rag_tools_intro">#</a> <b><u>PromptingTools.Experimental.RAGTools.build_qa_evals</u></b> — <i>Function</i>. <div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">build_qa_evals</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(doc_chunks</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Vector{&lt;:AbstractString}</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, sources</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Vector{&lt;:AbstractString}</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">               model</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">PT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">MODEL_CHAT, instructions</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;None.&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, qa_template</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Symbol</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:RAGCreateQAFromContext</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">               verbose</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Bool</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, api_kwargs</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">NamedTuple</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> NamedTuple</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(), kwargs</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Vector{QAEvalItem}</span></span></code></pre></div><p>Create a collection of question and answer evaluations (<code>QAEvalItem</code>) from document chunks and sources. This function generates Q&amp;A pairs based on the provided document chunks, using a specified AI model and template.</p><p><strong>Arguments</strong></p><ul><li><p><code>doc_chunks::Vector{&lt;:AbstractString}</code>: A vector of document chunks, each representing a segment of text.</p></li><li><p><code>sources::Vector{&lt;:AbstractString}</code>: A vector of source identifiers corresponding to each chunk in <code>doc_chunks</code> (eg, filenames or paths).</p></li><li><p><code>model</code>: The AI model used for generating Q&amp;A pairs. Default is <code>PT.MODEL_CHAT</code>.</p></li><li><p><code>instructions::String</code>: Additional instructions or context to provide to the model generating QA sets. Defaults to &quot;None.&quot;.</p></li><li><p><code>qa_template::Symbol</code>: A template symbol that dictates the AITemplate that will be used. It must have placeholder <code>context</code>. Default is <code>:CreateQAFromContext</code>.</p></li><li><p><code>api_kwargs::NamedTuple</code>: Parameters that will be forwarded to the API endpoint.</p></li><li><p><code>verbose::Bool</code>: If <code>true</code>, additional information like costs will be logged. Defaults to <code>true</code>.</p></li></ul><p><strong>Returns</strong></p><p><code>Vector{QAEvalItem}</code>: A vector of <code>QAEvalItem</code> structs, each containing a source, context, question, and answer. Invalid or empty items are filtered out.</p><p><strong>Notes</strong></p><ul><li><p>The function internally uses <code>aiextract</code> to generate Q&amp;A pairs based on the provided <code>qa_template</code>. So you can use any kwargs that you want.</p></li><li><p>Each <code>QAEvalItem</code> includes the context (document chunk), the generated question and answer, and the source.</p></li><li><p>The function tracks and reports the cost of AI calls if <code>verbose</code> is enabled.</p></li><li><p>Items where the question, answer, or context is empty are considered invalid and are filtered out.</p></li></ul><p><strong>Examples</strong></p><p>Creating Q&amp;A evaluations from a set of document chunks:</p><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">doc_chunks </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Text from document 1&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Text from document 2&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">sources </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;source1&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;source2&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">qa_evals </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> build_qa_evals</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(doc_chunks, sources)</span></span></code></pre></div><p><a href="https://github.com/svilupp/PromptingTools.jl/blob/1671239c38c0b309f52f81d9522c51f593517a4f/src/Experimental/RAGTools/evaluation.jl#L65-L100" target="_blank" rel="noreferrer">source</a></p></div><br>', 71);
const _hoisted_72 = [
  _hoisted_1
];
function _sfc_render(_ctx, _cache, $props, $setup, $data, $options) {
  return openBlock(), createElementBlock("div", null, _hoisted_72);
}
const rag_tools_intro = /* @__PURE__ */ _export_sfc(_sfc_main, [["render", _sfc_render]]);
export {
  __pageData,
  rag_tools_intro as default
};
